# CI/CD

1. У всех получилось всё установить всё?

2. Кто работал с докером?

3. Системы виртуализацию.

Virtual Box. Свою среду под тестирование нашего продукта. Иметь Ubuntu-среду + чтобы там было всё развернутов(фронтент + бэкенд + базы данных). Собираем стенд.

- Находим нужный образ(или скачиваем с интернета).
- Начинаем настраивать CPU/Память/Видео память. 2 СPU/8 Гб/сколько нужно.
- Развернем фронтент, развернем бэк, базы, накатим дамп и т.д.
- Можем запускать тесты.

Какие варианты реального развертывания?

- Виртуальный машина удаленная(экрана нет) или выделенный сервер.
- Облачное решение(контейнер или даже лямбда).

Почему докер?

1. Нам нужна леговестность.
2. Нам нужна автоматизация.
3. Легкость в развертывании.
4. Повторяймость.
5. Изоляция.

Почему легковестность. По факту, докер-контейнер. Есть веб-сервер. Нужна ли ему вся Ubuntu?

Когда мы создаем образ. Одни образ - один процесс(программа). Фронт/бэк/база данных(3 разных образа и контейнера)

Ubuntu операционная система на базе Linux/Unix. 

Использует декларативный подход.

Каждый шаг - это действие чтобы получить конечный результат.

Поставим задачу - я хочу запустить веб-сервер на базе NodeJS(express).

1 Шаг. Взять образ какой-то OS, где есть NodeJS.
2 Шаг. Устанавливаем все зависимости(jest и т.д.).
3 Шаг. Были наши исходники.
4 Шаг. Какое-то действие выполнили(запустили тесты).

Команды
docker pull hello-world. pull стягивает с удаленной машины на нашу машину образ hello-world.
docker run hello-world. Мы из образа создаем контейнер и запускаем его.
docker build ./ - это создание образа из Dockerfile "." - это контекст запуска
docker ps - список все рабочих контейнеров.
docker ps --all - список когда либо запущенных контейнеров













https://github.com/nlapshin/nodejs-qa-docker

Github Actions, Gitlab, Bamboo, CircleCI, Jenkins, Teamcity.

- А зачем нам все это? CI и CD, что это?

удобный релиз + доставка кода.
автоматизация процессов.
тесты сразу как запушили.

Не баш скрипты, а множество баш скриптов + знание людей.

Не надежно + траты человека часов.

CI/CD

цена + штат

Github Actions, Gitlab, Bamboo, CircleCI, Jenkins, Teamcity.

Github Actions и Jenkins - они бесплатные.

- на что можно поделить?

Pipeline - запускать пайплайны(последовательность действий).
Runner - это грубо говоря сервера, где запускаются наши пайплайны.
Features - нотификации, интеграции, удобный интерфейс. Docker registry или npm registiry.

Наше тех. задание.

Создать pipeline со следующими требования:

- собирает проект и запускает наши тесты
- наш пайплайн запускается когда кто-то создает pull-request в ветку main.
- генерирует reports +
- генерирует coverage +
- Публикация на github pages
- нотификацию в Telegram
- выполнять программный код
- Cron job с полным набором.

Как мы запускаем наши пайплайны:
Опишите последовательность действий которые нужно сделать с git-репозиторием, чтобы запустить тесты.

1. Сколнировать репозиторий.
2. npm i
3. npm test
- собирает проект и запускает наши тесты +
- наш пайплайн запускается когда кто-то создает pull-request в ветку main. +
- 
Пайплайн:
- сама сборка проекта.
- создание тестовых стендов.
- запуск e2e-тестов: создать стенд + запустить тесты.

Как мы запускаем наши пайплайны:

- вручную
- по событию(pull-request, push и т.д.) - e2e тесты будет слишком долго.
- по расписанию - раз в сутки перед или после рабочего дня


Сron

s m H M Y Weekday
* * * * * *

"0 2 * * 1-5"

[16.x]

[14.x, 16.x, 18.x] - такой подход необходим для пакетов nodeJS

- run: npm ci // install
- run: npm run build --if-present // build если надо
- run: npm test

docker build . --tag nlapshin/node-docker-qa - собирает образ и задаем ему имя nlapshin/node-docker-qa

Число 18

docker build ./path/to/directory Точка - это контекст(в разрезе файловой системы) запуска

docker ps - посмотреть список всех запущенных контейнеров.
docker rm <name> - это удалить контейнер
docker run -it - запустить в интерактивном режим
docker exec -it my-qa-container sh - подключить к терминалу контейнера

1. Есть билд-сервер, который собирает образы.
2. Мы имея систему CI/CD жмек кнопку собрать образ.
3. Образ собирается, вешает тэг и публикуется в registry.
4. Нажимаем кнопку, которая говорит другому серверу(скачай образ с таким тэгом и запусти его)
=======
- run: npm ci // install
- run: npm run build --if-present // build если надо
- run: npm test


Что я сделал?
1. Создал ветку: git checkout -b new-feature
2. git push --set-upstream origin new-feature 
3. Добавил код(любой)
4. git add .
5. git commit -m 'New commit'
6. git push
7. Пошел на github и создал pull request
>>>>>>> Stashed changes
>>>>>>> Stashed changes

// Что нужно реализовать?

1. Создать бота(botFather)
2. Бот может слать конкретному человеку или в приватный чат. Создать чат и добавить туда бота.
3. Нужно получить secrets: token(выдает botFather) и id пользователя или чата(через API).
4. Добавить эти secrets в github
5. Создать step


https://api.telegram.org/bot/getUpdates


// Token: 5897961554:AAHNK31px2AqgHCtSeggzv-Ni7OvnQUGZ1c
// ChatId: -892666022
